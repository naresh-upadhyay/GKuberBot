<!DOCTYPE html>
<html>
<head>
    <title>Strategy Builder</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet">

    <style>
        body { background:#f4f6fa; }
        .card { border-radius:14px; box-shadow:0 10px 25px rgba(0,0,0,.08); }
        label { font-weight:600; font-size:14px; }
    </style>
</head>
<body>

<div class="container mt-4">

<!-- LOAD STRATEGY -->
<div class="card p-3 mb-4">
    <label>Saved Strategies</label>
    <div class="row g-2">
        <div class="col-md-9">
            <select id="strategySelect" class="form-select">
                <option value="">-- Select Strategy --</option>
                {% for sid, s in strategies.items() %}
                    <option value="{{ sid }}">{{ s.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-3">
            <button class="btn btn-primary w-100" onclick="loadStrategy()">Load</button>
        </div>
    </div>
</div>

<!-- BUILDER -->
<div class="card p-4">
<h4 class="text-center mb-4">ðŸ“Š Strategy Builder</h4>

<label>Strategy Name</label>
<input id="strategy_name" class="form-control mb-3">

<label>Coins</label>
<select id="coins" class="form-control mb-3" multiple>
{% for c in coins %}<option>{{ c }}</option>{% endfor %}
</select>

<div class="row mb-3">
<div class="col-md-6">
<label>From</label>
<input type="date" id="from_date" class="form-control">
</div>
<div class="col-md-6">
<label>To</label>
<input type="date" id="to_date" class="form-control">
</div>
</div>

<h6>Buy</h6>
<div class="row mb-3">
<div class="col-md-4">
<label>Min RSI</label>
<select id="buy_rsi_min" class="form-select">{% for r in rsi_values %}<option>{{ r }}</option>{% endfor %}</select>
</div>
<div class="col-md-4">
<label>MACD</label>
<select id="buy_macd" class="form-select">{% for m in macd %}<option value="{{ m.value }}">{{ m.label }}</option>{% endfor %}</select>
</div>
<div class="col-md-4">
<label>Candle</label>
<select id="buy_candle" class="form-select">{% for c in candles %}<option value="{{ c.value }}">{{ c.label }}</option>{% endfor %}</select>
</div>
</div>

<h6>Sell</h6>
<div class="row mb-4">
<div class="col-md-3">
<label>Min RSI</label>
<select id="sell_rsi_min" class="form-select">{% for r in rsi_values %}<option>{{ r }}</option>{% endfor %}</select>
</div>
<div class="col-md-3">
<label>Max RSI</label>
<select id="sell_rsi_max" class="form-select">{% for r in rsi_values %}<option>{{ r }}</option>{% endfor %}</select>
</div>
<div class="col-md-3">
<label>MACD</label>
<select id="sell_macd" class="form-select">{% for m in macd %}<option value="{{ m.value }}">{{ m.label }}</option>{% endfor %}</select>
</div>
<div class="col-md-3">
<label>Candle</label>
<select id="sell_candle" class="form-select">{% for c in candles %}<option value="{{ c.value }}">{{ c.label }}</option>{% endfor %}</select>
</div>
</div>

<div class="d-flex gap-2">
<button class="btn btn-outline-primary" onclick="save()">ðŸ’¾ Save</button>
<button class="btn btn-secondary" onclick="saveAsNew()">ðŸ†• Save As New</button>
<button class="btn btn-success ms-auto" onclick="run()">â–¶ Start Scanner</button>
</div>
</div>

<!-- RESULTS -->
<div class="card p-4 mt-4 d-none" id="results">
<h5>ðŸ“ˆ Results</h5>
<table class="table table-bordered">
<thead><tr><th>Symbol</th><th>Trades</th><th>Wins</th><th>Win %</th><th>PnL</th></tr></thead>
<tbody id="resBody"></tbody>
</table>
<h5 class="text-end">ðŸ”¥ TOTAL PnL: <span id="total"></span></h5>
</div>

</div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
$('#coins').select2({width:'100%'});

let currentId = null;

function collect() {
    return {
        coins: $('#coins').val(),
        date_range:{from:from_date.value,to:to_date.value},
        buy:{rsi_min:buy_rsi_min.value,macd:buy_macd.value,candle:buy_candle.value},
        sell:{rsi_min:sell_rsi_min.value,rsi_max:sell_rsi_max.value,macd:sell_macd.value,candle:sell_candle.value}
    };
}

function fill(s){
    currentId = s.id;
    strategy_name.value = s.name;
    const c = s.config;
    $('#coins').val(c.coins).trigger('change');
    from_date.value = c.date_range.from;
    to_date.value = c.date_range.to;
    buy_rsi_min.value = c.buy.rsi_min;
    buy_macd.value = c.buy.macd;
    buy_candle.value = c.buy.candle;
    sell_rsi_min.value = c.sell.rsi_min;
    sell_rsi_max.value = c.sell.rsi_max;
    sell_macd.value = c.sell.macd;
    sell_candle.value = c.sell.candle;
}

function loadStrategy(){
    const id = strategySelect.value;
    if(!id){ alert("Select a strategy"); return; }
    fetch(`/load-strategy/${id}`).then(r=>r.json()).then(fill);
}

function save(){
    fetch('/save-strategy',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({id:currentId,name:strategy_name.value,config:collect()})
    }).then(r=>r.json()).then(d=>{currentId=d.strategy_id;location.reload();});
}

function saveAsNew(){
    currentId=null;
    strategy_name.value += " (Copy)";
    save();
}

function run(){
    fetch('/start-scanner',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify(collect())
    }).then(r=>r.json()).then(d=>{
        resBody.innerHTML="";
        d.results.forEach(r=>{
            resBody.innerHTML+=`<tr>
                <td>${r.symbol}</td><td>${r.trades}</td>
                <td>${r.wins}</td>
                <td>${((r.wins/r.trades)*100).toFixed(2)}%</td>
                <td>${r.pnl.toFixed(2)}</td></tr>`;
        });
        total.innerText=d.total_pnl.toFixed(2);
        results.classList.remove('d-none');
    });
}

// auto load last
const last = {{ last_strategy | tojson | safe }};
if(last) fill(last);
</script>

</body>
</html>
